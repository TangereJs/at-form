
<link rel="import" href="../paper-button/paper-button.html" />
<link rel="import" href="../core-ajax/core-ajax.html" />
<link rel="import" href="../at-core-form/at-core-form.html" />

<polymer-element name="at-form" attributes="schema data url">
  <template>
    <core-ajax id="submitAjax" url="{{ url }}" method="POST" contentType="application/json" withCredentials  on-core-response="{{ submitResponse }}" on-core-error="{{ submitError }}"></core-ajax>
    <div vertical layout>
      <at-core-form id="form" schema="{{ schema }}" data="{{ data }}"></at-core-form>
      <div horizontal layout left-justified>
        <label id="errorLabel"></label>
      </div>
        <div horizontal layout left-justified>
          <paper-button id="submit" raised role="button">Submit</paper-button>
        </div>
      </div>
  </template>
  <script>
    Polymer('at-form', {
      ready: function () {
        var self = this;
        var formObserver = new ObjectObserver(this.$.form);
        formObserver.open(function (added, removed, changed, getOldValueFn) {
          Object.keys(changed).forEach(function (property) {
            if (property === "valid_") {
              self.$.submit.disabled = !changed[property];
            }
          });
        });

        this.$.submit.disabled = !this.$.form.valid;

        this.$.submit.addEventListener('click', function (event) {
          // disable the form
          self.disableForm();

          var data = JSON.stringify(self.$.form.dataBindingObject);
          self.$.submitAjax.body = data;
          self.$.submitAjax.go();
        });
      },
      submitResponse: function (event, response) {
        this.$.errorLabel.textContent = response.response;        
        //enable the form
        this.enableForm();
        // if submit was successfull fire success event
        var resObj = JSON.parse(response.response);
        var errorCode = resObj.ErrorCode;
        if (errorCode === 0) {
          this.fire('success');
        }
      },
      submitError: function (event, response) {
        //debugger;
        var xhr = response.xhr;
        this.$.errorLabel.textContent = xhr.responseURL + " " + xhr.status + ": " + response.xhr.statusText;

        //enable the form
        this.enableForm();
      },
      enableForm: function () {
        this.$.submit.setAttribute('disabled', 'false');
        this.$.form.setAttribute('disabled', 'false');
      },
      disableForm: function () {
        this.$.submit.setAttribute('disabled', 'true');
        this.$.form.setAttribute('disabled', 'true');
      }
    });
  </script>
</polymer-element>
