<link rel="import" href="../core-ajax/core-ajax.html" />
<link rel="import" href="../at-core-form/at-core-form.html" />
<link rel="import" href="../layout/layout.html" />

<dom-module id="at-form">
  <template>
    <core-ajax id="submitAjax" url="{{url}}" method="POST" content-type="application/json" on-response="submitResponse" on-error="submitError"></core-ajax>
    <div class="vertical layout">
      <at-core-form id="form" schema="{{schema}}" data="{{data}}"></at-core-form>
      <div class="horizontal layout left-justified">
        <label id="errorLabel"></label>
      </div>
      <div class="horizontal layout left-justified">
        <input type="button" id="submit" role="button" value="Submit"></input>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'at-form',
    properties: {
      schema: {
        type: Object,
        value: {},
        notify: true
      },
      data: {
        type: Object,
        value: {},
        notify: true
      },
      url: {
        type: String,
        value: '',
        notify: true
      }
    },
    ready: function () {
      var self = this;
      this.$.form.addEventListener('valid-changed', function (e) {
        if (!self.$.form.valid) {
          self.$.submit.setAttribute('disabled', true);
        } else {
          self.$.submit.removeAttribute('disabled');
        }
      });

      if (!this.$.form.valid) {
        this.$.submit.setAttribute('disabled', true);
      } else {
        this.$.submit.removeAttribute('disabled');
      }

      this.$.submit.addEventListener('click', function (event) {
        // disable the form
        self.disableForm();
        self.$.form.updateValidState();

        var data = JSON.stringify(self.$.form.data);
        self.$.submitAjax.body = data;
        self.$.submitAjax.generateRequest();
      });
    },
    submitResponse: function (event, response) {
      //enable the form
      this.enableForm();
      this.$.form.updateValidState();

      // if submit was successfull fire success event
      var resObj = response;
      var errorCode = resObj.ErrorCode;
      if (errorCode === 0) {
        this.fire('success');
      } else {
        this.fire('error', errorCode + ' ' + resObj.Data.ErrorText);
      }
    },
    submitError: function (event, response) {
      //debugger;
      var xhr = response.xhr;
      this.$.errorLabel.textContent = xhr.responseURL + " " + xhr.status + ": " + response.xhr.statusText;

      //enable the form
      this.enableForm();
    },
    enableForm: function () {
      this.$.submit.removeAttribute('disabled');
      this.$.form.setAttribute('disabled', 'false');
    },
    disableForm: function () {
      this.$.submit.setAttribute('disabled', 'true');
      this.$.form.setAttribute('disabled', 'true');
    }
  });
</script>