<link rel="import" href="../at-core-activity/at-core-activity.html" />
<link rel="import" href="../at-core-form/at-core-form.html" />
<link rel="import" href="../layout/layout.html" />

<dom-module id="at-form">
  <template>
    <at-core-activity id="submitAjax" url="{{url}}" method="POST" content-type="application/json" on-response="onResponse" on-error="onError"></at-core-activity>
    <div class="vertical layout">
      <at-core-form id="form" schema="{{schema}}" data="{{data}}" layout="{{layout}}"></at-core-form>
      <div class="horizontal layout left-justified">
        <label id="errorLabel"></label>
      </div>
      <div class="horizontal layout left-justified">
        <input type="button" id="submit" role="button" value="Submit"></input>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'at-form',
    properties: {
      schema: {
        type: Object,
        value: {},
        notify: true
      },
      data: {
        type: Object,
        value: {},
        notify: true
      },
      url: {
        type: String,
        value: '',
        notify: true
      },
      layout: {
        type: String,
        value: 'vertical'        
      }
    },
    ready: function () {
      var self = this;

      this.$.submit.addEventListener('click', function (event) {
        // validate the form
        var isFormValid = self.$.form.validate();

        if (isFormValid) {
          // if form is valid

          // disable the form
          self.disableForm();

          // send the request to the server
          var data = JSON.stringify(self.$.form.data);
          self.$.submitAjax.body = data;
          self.$.submitAjax.generateRequest();
        }
      });
    },
    onResponse: function (event, response) {
      //enable the form
      this.enableForm();

      // if submit was successfull fire success event
      var resObj = response;
      var errorCode = resObj.ErrorCode;
      if (errorCode === 0) {
        this.fire('success');
      } else {
        this.fire('error', errorCode + ' ' + resObj.Data.ErrorText);
      }
    },
    onError: function (event, response) {
      //show the error message
      var xhr = response.xhr;
      if (xhr) {
        this.$.errorLabel.textContent = xhr.responseURL + " " + xhr.status + ": " + response.xhr.statusText;
      } else {
        this.$.errorLabel.innerHTML = response;
      }

      //enable the form
      this.enableForm();
    },
    enableForm: function () {
      this.$.submit.removeAttribute('disabled');
      this.$.form.disabled = false;
    },
    disableForm: function () {
      this.$.submit.setAttribute('disabled', 'true');
      this.$.form.disabled = true;
    }
  });
</script>
